<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moja Książka Kucharska</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 0.5rem;
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Search Bar */
        .search-container {
            margin-bottom: 2rem;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            font-size: 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--surface-color);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .search-results-info {
            margin-bottom: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* AI Toggle */
        .ai-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: var(--border-radius);
        }

        .ai-checkbox {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: var(--primary-color);
        }

        .ai-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary-color);
        }

        .api-key-input {
            width: 220px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
        }

        .hidden { display: none !important; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn--primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn--primary:hover {
            background-color: var(--primary-hover);
        }

        .btn--secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn--success {
            background-color: var(--success-color);
            color: white;
        }

        .btn--warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn--sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn--xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Recipes Grid */
        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .recipe-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .recipe-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .recipe-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            position: relative;
            overflow: hidden;
        }

        .recipe-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recipe-image-fallback {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 2rem;
        }

        .recipe-content {
            padding: 1.5rem;
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .recipe-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0;
            line-height: 1.3;
        }

        .recipe-title a {
            color: inherit;
            text-decoration: none;
        }

        .recipe-title a:hover {
            color: var(--primary-color);
        }

        .recipe-time {
            background: var(--warning-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .recipe-ingredients, .recipe-instructions {
            margin-bottom: 1rem;
        }

        .recipe-ingredients h4, .recipe-instructions h4 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .ingredients-list, .instructions-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .ingredients-list li {
            padding: 0.25rem 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .ingredients-list li:before {
            content: "• ";
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .instructions-list {
            counter-reset: step-counter;
        }

        .instructions-list li {
            counter-increment: step-counter;
            padding: 0.5rem 0;
            color: var(--text-muted);
            font-size: 0.9rem;
            position: relative;
            padding-left: 2rem;
        }

        .instructions-list li:before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0.5rem;
            background: var(--primary-color);
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .recipe-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .delete-btn, .edit-btn, .view-btn {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .delete-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .delete-btn:hover {
            background-color: #b91c1c;
        }

        .edit-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .edit-btn:hover {
            background-color: #475569;
        }

        .view-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .view-btn:hover {
            background-color: var(--primary-hover);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Full Recipe View Modal */
        .recipe-view-modal .modal-content {
            max-width: 800px;
        }

        .recipe-view-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .recipe-view-image {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .recipe-view-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recipe-view-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .recipe-view-time {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .recipe-view-source {
            margin-bottom: 2rem;
        }

        .recipe-view-source a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .recipe-view-source a:hover {
            text-decoration: underline;
        }

        .recipe-view-section {
            margin-bottom: 2rem;
        }

        .recipe-view-section h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .recipe-view-ingredients {
            display: grid;
            gap: 0.5rem;
            counter-reset: none;
        }

        .recipe-view-ingredients li {
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            list-style: none;
        }

        .recipe-view-instructions {
            display: grid;
            gap: 1rem;
            counter-reset: step-counter;
        }

        .recipe-view-instructions li {
            counter-increment: step-counter;
            padding: 1rem;
            background: #f8fafc;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            position: relative;
            padding-left: 3rem;
            list-style: none;
        }

        .recipe-view-instructions li:before {
            content: counter(step-counter);
            position: absolute;
            left: 1rem;
            top: 1rem;
            background: var(--success-color);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Form */
        .extraction-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f0f9ff;
            border-radius: var(--border-radius);
            border: 1px solid #bae6fd;
        }

        .extraction-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .divider {
            text-align: center;
            margin: 2rem 0;
            position: relative;
            color: var(--text-muted);
            font-weight: 500;
        }

        .divider:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .divider:after {
            content: attr(data-text);
            background: var(--surface-color);
            padding: 0 1rem;
        }

        .recipe-form h3 {
            color: var(--success-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        /* Status */
        .extraction-status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }

        .extraction-status.success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .extraction-status.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .extraction-status.info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #dbeafe;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .empty-state p {
            margin-bottom: 1rem;
        }

        /* No Results State */
        .no-results {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .no-results h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .header-controls {
                flex-direction: column;
                width: 100%;
            }

            .ai-toggle {
                justify-content: center;
            }

            .recipes-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }

            .form-actions, .recipe-actions {
                flex-direction: column;
            }

            .recipe-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .recipe-time {
                align-self: flex-start;
            }

            .recipe-view-title {
                font-size: 1.5rem;
            }

            .recipe-view-image {
                height: 200px;
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with AI Toggle -->
        <header class="header">
            <h1>🍳 Moja Książka Kucharska</h1>
            <div class="header-controls">
                <div class="ai-toggle">
                    <input type="checkbox" id="aiEnabled" class="ai-checkbox">
                    <label for="aiEnabled" class="ai-label">🤖 Claude AI</label>
                </div>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    class="api-key-input hidden" 
                    placeholder="Klucz Claude API (sk-ant-...)"
                >
                <button class="btn btn--primary" id="addRecipeBtn">
                    <span class="btn-icon">+</span>
                    Dodaj Przepis
                </button>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-icon">🔍</div>
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="Szukaj przepisów po nazwie lub składnikach..."
            >
        </div>

        <!-- Search Results Info -->
        <div class="search-results-info hidden" id="searchResultsInfo">
            Znaleziono <span id="resultsCount">0</span> przepisów
        </div>

        <!-- Recipes Grid -->
        <main class="main">
            <div class="recipes-grid" id="recipesGrid">
                <!-- Recipes will be displayed here -->
            </div>
        </main>

        <!-- Add/Edit Recipe Modal -->
        <div class="modal hidden" id="recipeModal">
            <div class="modal-backdrop" id="modalBackdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Dodaj Nowy Przepis</h2>
                    <button class="btn btn--secondary btn--sm" id="closeModalBtn">×</button>
                </div>
                <div class="modal-body">
                    <!-- URL Extraction Section (only for new recipes) -->
                    <div class="extraction-section" id="extractionSection">
                        <h3>🔍 Automatyczne wyodrębnianie przepisu</h3>
                        <div class="form-group">
                            <label class="form-label" for="recipeUrl">Wklej link do przepisu:</label>
                            <input type="url" class="form-control" id="recipeUrl" placeholder="https://example.com/recipe">
                        </div>
                        <button class="btn btn--primary" id="extractBtn">
                            <span class="extract-text">Wyodrębnij przepis</span>
                            <span class="loading-spinner hidden">⌛</span>
                        </button>
                        <div class="extraction-status hidden" id="extractionStatus"></div>
                    </div>

                    <div class="divider" data-text="LUB" id="dividerSection"></div>

                    <!-- Manual Recipe Form -->
                    <div class="recipe-form">
                        <h3 id="formTitle">📝 Wprowadź przepis ręcznie</h3>
                        
                        <div class="form-group">
                            <label class="form-label" for="recipeName">Nazwa przepisu:</label>
                            <input type="text" class="form-control" id="recipeName" placeholder="np. Kotlety schabowe">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="prepTime">Czas przygotowania:</label>
                            <input type="text" class="form-control" id="prepTime" placeholder="np. 30 min">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="ingredients">Składniki (jeden w każdej linii):</label>
                            <textarea class="form-control" id="ingredients" rows="6" placeholder="500g mąki&#10;2 jajka&#10;300ml mleka"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="instructions">Instrukcje (jeden krok w każdej linii):</label>
                            <textarea class="form-control" id="instructions" rows="6" placeholder="Wymieszaj mąkę z jajkami&#10;Dodaj mleko i mieszaj&#10;Smaż na patelni"></textarea>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn--secondary" id="cancelBtn">Anuluj</button>
                            <button class="btn btn--primary" id="saveBtn">💾 Zapisz przepis</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recipe View Modal -->
        <div class="modal hidden recipe-view-modal" id="recipeViewModal">
            <div class="modal-backdrop" id="viewModalBackdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="viewModalTitle">Przepis</h2>
                    <button class="btn btn--secondary btn--sm" id="closeViewModalBtn">×</button>
                </div>
                <div class="modal-body">
                    <div class="recipe-view-header">
                        <div class="recipe-view-image" id="viewRecipeImage">
                            🍳
                        </div>
                        <h1 class="recipe-view-title" id="viewRecipeName">Nazwa przepisu</h1>
                        <div class="recipe-view-time" id="viewRecipeTime">⏱️ Czas przygotowania</div>
                        <div class="recipe-view-source hidden" id="viewRecipeSource">
                            <a href="#" target="_blank" id="viewSourceLink">🔗 Zobacz oryginalny przepis</a>
                        </div>
                    </div>

                    <div class="recipe-view-section">
                        <h3>📋 Składniki</h3>
                        <ul class="recipe-view-ingredients" id="viewRecipeIngredients">
                            <!-- Ingredients will be displayed here -->
                        </ul>
                    </div>

                    <div class="recipe-view-section">
                        <h3>👩‍🍳 Instrukcje przygotowania</h3>
                        <ol class="recipe-view-instructions" id="viewRecipeInstructions">
                            <!-- Instructions will be displayed here -->
                        </ol>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn--secondary" id="editFromViewBtn">✏️ Edytuj przepis</button>
                        <button class="btn btn--primary" id="closeViewBtn">Zamknij</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        class RecipeExtractor {
            constructor() {
                this.apiKey = localStorage.getItem('claude_api_key') || '';
            }

            setApiKey(key) {
                this.apiKey = key;
                localStorage.setItem('claude_api_key', key);
            }

            async extractRecipe(url, useAI = false) {
                console.log('🔍 Analizuję:', url, useAI ? 'z Claude AI' : 'bez AI');
                
                try {
                    // Spróbuj najpierw ScrapingBee (bez kluczy API)
                    const scrapingBeeRecipe = await this.tryScrapingBee(url);
                    if (scrapingBeeRecipe) {
                        console.log('✅ Sukces ze ScrapingBee');
                        scrapingBeeRecipe.source = url;
                        return scrapingBeeRecipe;
                    }

                    // Spróbuj Browserless (bez kluczy API)
                    const browserlessRecipe = await this.tryBrowserless(url);
                    if (browserlessRecipe) {
                        console.log('✅ Sukces z Browserless');
                        browserlessRecipe.source = url;
                        return browserlessRecipe;
                    }

                    // Dedykowane parsery dla polskich stron
                    const specialRecipe = await this.trySpecialParser(url);
                    if (specialRecipe) {
                        console.log('✅ Użyto dedykowanego parsera');
                        specialRecipe.source = url;
                        return specialRecipe;
                    }
                    
                    // Standardowe proxy
                    const html = await this.fetchPageContent(url);
                    console.log('✅ Pobrano zawartość strony');
                    
                    const imageUrl = this.extractImageFromHtml(html, url);
                    
                    // JSON-LD parser
                    const jsonRecipe = this.parseJsonLD(html);
                    if (jsonRecipe && jsonRecipe.ingredients.length > 1 && jsonRecipe.instructions.length > 1) {
                        console.log('✅ Znaleziono pełny JSON-LD');
                        jsonRecipe.source = url;
                        jsonRecipe.image = imageUrl;
                        return jsonRecipe;
                    }
                    
                    // Claude AI
                    if (useAI && this.apiKey) {
                        console.log('🤖 Używam Claude AI');
                        const aiRecipe = await this.parseWithClaude(html, url);
                        aiRecipe.source = url;
                        aiRecipe.image = imageUrl;
                        return aiRecipe;
                    }
                    
                    // Fallback
                    const basicRecipe = this.parseAdvancedHTML(html, url);
                    basicRecipe.source = url;
                    basicRecipe.image = imageUrl;
                    return basicRecipe;
                    
                } catch (error) {
                    console.error('❌ Szczegółowy błąd:', error);
                    throw error;
                }
            }

            // ScrapingBee - darmowa wersja
            async tryScrapingBee(url) {
                try {
                    // ScrapingBee ma darmową wersję bez kluczy API
                    const proxyUrl = `https://scrapingbee.com/api/v1/?api_key=demo&url=${encodeURIComponent(url)}&render_js=false`;
                    
                    console.log('🐝 Próbuję ScrapingBee...');
                    const response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const html = await response.text();
                        return this.parseHtmlToRecipe(html, url);
                    }
                } catch (e) {
                    console.log('⚠️ ScrapingBee nie działa');
                }
                return null;
            }

            // Browserless.io - darmowa wersja
            async tryBrowserless(url) {
                try {
                    console.log('🌐 Próbuję Browserless...');
                    
                    // Endpoint publiczny Browserless
                    const response = await fetch('https://chrome.browserless.io/content', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: url,
                            waitFor: 2000
                        })
                    });
                    
                    if (response.ok) {
                        const html = await response.text();
                        return this.parseHtmlToRecipe(html, url);
                    }
                } catch (e) {
                    console.log('⚠️ Browserless nie działa');
                }
                return null;
            }

            // Uniwersalny parser HTML -> przepis
            parseHtmlToRecipe(html, url) {
                // JSON-LD jest najlepszy
                const jsonRecipe = this.parseJsonLD(html);
                if (jsonRecipe && jsonRecipe.ingredients.length > 2 && jsonRecipe.instructions.length > 2) {
                    jsonRecipe.image = this.extractImageFromHtml(html, url);
                    return jsonRecipe;
                }

                // Mikrodata
                const microdataRecipe = this.parseMicrodata(html);
                if (microdataRecipe && microdataRecipe.ingredients.length > 2) {
                    microdataRecipe.image = this.extractImageFromHtml(html, url);
                    return microdataRecipe;
                }

                // Inteligentny HTML parser
                const htmlRecipe = this.parseIntelligentHTML(html, url);
                if (htmlRecipe && htmlRecipe.ingredients.length > 2) {
                    return htmlRecipe;
                }

                return null;
            }

            // Parser Microdata (schema.org)
            parseMicrodata(html) {
                try {
                    // Szukaj itemtype="https://schema.org/Recipe"
                    const recipeMatch = html.match(/<[^>]+itemtype="[^"]*schema\.org\/Recipe"[^>]*>(.*?)<\/[^>]+>/s);
                    if (!recipeMatch) return null;

                    const recipeHtml = recipeMatch[0];
                    
                    // Nazwa
                    const nameMatch = recipeHtml.match(/itemprop="name"[^>]*>([^<]+)</);
                    const name = nameMatch ? this.cleanText(nameMatch[1]) : 'Przepis';

                    // Składniki
                    const ingredients = [];
                    const ingredientMatches = recipeHtml.match(/itemprop="recipeIngredient"[^>]*>([^<]+)</g) || [];
                    ingredientMatches.forEach(match => {
                        const ingredient = this.cleanText(match.replace(/itemprop="recipeIngredient"[^>]*>/, ''));
                        if (ingredient.length > 2) ingredients.push(ingredient);
                    });

                    // Instrukcje
                    const instructions = [];
                    const instructionMatches = recipeHtml.match(/itemprop="recipeInstructions"[^>]*>(.*?)<\//gs) || [];
                    instructionMatches.forEach(match => {
                        const instruction = this.cleanText(match.replace(/itemprop="recipeInstructions"[^>]*>/, ''));
                        if (instruction.length > 10) instructions.push(instruction);
                    });

                    if (ingredients.length > 0 || instructions.length > 0) {
                        return {
                            name,
                            prepTime: 'Sprawdź na stronie',
                            ingredients: ingredients.length > 0 ? ingredients : ['Sprawdź składniki na oryginalnej stronie'],
                            instructions: instructions.length > 0 ? instructions : ['Zobacz instrukcje na oryginalnej stronie']
                        };
                    }
                } catch (e) {
                    console.warn('Błąd parsowania Microdata:', e);
                }
                return null;
            }

            // Inteligentny HTML parser
            parseIntelligentHTML(html, url) {
                const domain = new URL(url).hostname.toLowerCase();
                
                // Nazwa przepisu
                const titlePatterns = [
                    /<h1[^>]*class="[^"]*recipe[^"]*"[^>]*>(.*?)<\/h1>/i,
                    /<h1[^>]*class="[^"]*entry-title[^"]*"[^>]*>(.*?)<\/h1>/i,
                    /<h1[^>]*>(.*?)<\/h1>/i,
                    /<title[^>]*>(.*?)<\/title>/i
                ];

                let name = 'Przepis';
                for (const pattern of titlePatterns) {
                    const match = html.match(pattern);
                    if (match) {
                        name = this.cleanText(match[1]);
                        // Usuń typowe suffiksy
                        name = name.replace(/\s*[-|]\s*(Recipe|Przepis|Allrecipes).*$/i, '');
                        if (name.length > 5) break;
                    }
                }

                // Składniki - zaawansowane wzorce
                const ingredients = this.extractAdvancedIngredients(html);
                
                // Instrukcje - zaawansowane wzorce  
                const instructions = this.extractAdvancedInstructions(html);

                // Czas przygotowania
                const timePatterns = [
                    /prep[^>]*time[^>]*:?\s*(\d+\s*(?:min|hour|godz|h))/i,
                    /cooking[^>]*time[^>]*:?\s*(\d+\s*(?:min|hour|godz|h))/i,
                    /czas[^>]*:?\s*(\d+\s*(?:min|godz|h))/i
                ];

                let prepTime = 'Sprawdź na stronie';
                for (const pattern of timePatterns) {
                    const match = html.match(pattern);
                    if (match) {
                        prepTime = match[1];
                        break;
                    }
                }

                return {
                    name: this.normalizePolishText(name),
                    prepTime,
                    ingredients: ingredients.length > 0 ? ingredients : [`Nie udało się automatycznie wyodrębnić składników ze strony ${domain}`, 'Kliknij tytuł aby przejść na stronę źródłową'],
                    instructions: instructions.length > 0 ? instructions : [`Instrukcje dostępne na oryginalnej stronie ${domain}`, 'Kliknij tytuł aby przejść na stronę źródłową'],
                    image: this.extractImageFromHtml(html, url)
                };
            }

            // Zaawansowane wyodrębnianie składników
            extractAdvancedIngredients(html) {
                const patterns = [
                    // Klasy CSS
                    /<[^>]*class="[^"]*ingredient[^"]*"[^>]*>(.*?)<\/[^>]+>/gi,
                    /<[^>]*class="[^"]*recipe-ingredient[^"]*"[^>]*>(.*?)<\/[^>]+>/gi,
                    // Listy ze wskazówkami
                    /<ul[^>]*>[^<]*(?:<li[^>]*>[^<]*(?:cup|tbsp|tsp|gram|kg|ml|litr|łyżk|szklank)[^<]*<\/li>[^<]*){3,}[^<]*<\/ul>/gi,
                    // ID-based
                    /<[^>]*id="[^"]*ingredient[^"]*"[^>]*>(.*?)<\/[^>]+>/gi
                ];

                const ingredients = new Set();

                for (const pattern of patterns) {
                    const matches = html.match(pattern) || [];
                    for (const match of matches) {
                        // Wyodrębnij elementy listy
                        const listItems = match.match(/<li[^>]*>(.*?)<\/li>/gi) || [match];
                        
                        for (const item of listItems) {
                            const text = this.cleanText(item.replace(/<[^>]*>/g, ''));
                            if (this.looksLikeIngredient(text)) {
                                ingredients.add(text);
                            }
                        }
                    }
                }

                return Array.from(ingredients).slice(0, 20); // Max 20 składników
            }

            // Sprawdza czy tekst wygląda na składnik
            looksLikeIngredient(text) {
                if (text.length < 3 || text.length > 150) return false;
                
                // Słowa kluczowe składników
                const ingredientKeywords = [
                    'cup', 'tbsp', 'tsp', 'oz', 'lb', 'gram', 'kg', 'ml', 'litr', 'liter',
                    'łyżka', 'łyżeczka', 'szklanka', 'dag', 'dkg', 'garść', 'szczyptę',
                    'mąka', 'cukier', 'sól', 'pieprz', 'olej', 'masło', 'jajko', 'mleko',
                    'flour', 'sugar', 'salt', 'pepper', 'oil', 'butter', 'egg', 'milk'
                ];

                const lowerText = text.toLowerCase();
                return ingredientKeywords.some(keyword => lowerText.includes(keyword)) ||
                       /^\d+/.test(text) || // Zaczyna się od liczby
                       /\d+\s*(g|kg|ml|l|cup|tbsp|tsp|oz|lb)/.test(lowerText); // Zawiera jednostki
            }

            // Zaawansowane wyodrębnianie instrukcji
            extractAdvancedInstructions(html) {
                const patterns = [
                    /<[^>]*class="[^"]*instruction[^"]*"[^>]*>(.*?)<\/[^>]+>/gi,
                    /<[^>]*class="[^"]*recipe-instruction[^"]*"[^>]*>(.*?)<\/[^>]+>/gi,
                    /<[^>]*class="[^"]*method[^"]*"[^>]*>(.*?)<\/[^>]+>/gi,
                    /<ol[^>]*>[^<]*(?:<li[^>]*>[^<]{20,}[^<]*<\/li>[^<]*){2,}[^<]*<\/ol>/gi
                ];

                const instructions = new Set();

                for (const pattern of patterns) {
                    const matches = html.match(pattern) || [];
                    for (const match of matches) {
                        const listItems = match.match(/<li[^>]*>(.*?)<\/li>/gi) || [match];
                        
                        for (const item of listItems) {
                            const text = this.cleanText(item.replace(/<[^>]*>/g, ''));
                            if (this.looksLikeInstruction(text)) {
                                instructions.add(text);
                            }
                        }
                    }
                }

                return Array.from(instructions).slice(0, 15); // Max 15 kroków
            }

            // Sprawdza czy tekst wygląda na instrukcję
            looksLikeInstruction(text) {
                if (text.length < 10 || text.length > 500) return false;
                
                const instructionKeywords = [
                    'mix', 'stir', 'add', 'pour', 'cook', 'bake', 'heat', 'cool',
                    'wymieszaj', 'dodaj', 'podgrzej', 'piecz', 'gotuj', 'studzić', 'zalej'
                ];

                const lowerText = text.toLowerCase();
                return instructionKeywords.some(keyword => lowerText.includes(keyword)) ||
                       /^(krok\s*\d+|step\s*\d+|\d+\.)/i.test(text); // Zaczyna się od "Krok" lub numeru
            }

            // Normalizuj polski tekst (usuń HTML entities)
            normalizePolishText(text) {
                const entities = {
                    '&oacute;': 'ó', '&Oacute;': 'Ó',
                    '&aacute;': 'ą', '&Aacute;': 'Ą', 
                    '&eacute;': 'ę', '&Eacute;': 'Ę',
                    '&sacute;': 'ś', '&Sacute;': 'Ś',
                    '&nacute;': 'ń', '&Nacute;': 'Ń',
                    '&cacute;': 'ć', '&Cacute;': 'Ć',
                    '&zacute;': 'ź', '&Zacute;': 'Ź',
                    '&#322;': 'ł', '&#321;': 'Ł',
                    '&#380;': 'ż', '&#379;': 'Ż'
                };

                let normalized = text;
                for (const [entity, char] of Object.entries(entities)) {
                    normalized = normalized.replace(new RegExp(entity, 'g'), char);
                }

                // Ogólne HTML entities
                normalized = normalized
                    .replace(/&amp;/g, '&')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/&nbsp;/g, ' ');

                return normalized;
            }

            // Wyodrębnij zdjęcie z HTML
            extractImageFromHtml(html, baseUrl) {
                const imagePatterns = [
                    /"image":\s*"([^"]+)"/,
                    /"image":\s*\[\s*"([^"]+)"/,
                    /<meta[^>]*property="og:image"[^>]*content="([^"]+)"/,
                    /<img[^>]*class="[^"]*recipe[^"]*"[^>]*src="([^"]+)"/i,
                    /<img[^>]*class="[^"]*featured[^"]*"[^>]*src="([^"]+)"/i,
                    /<img[^>]*alt="[^"]*recipe[^"]*"[^>]*src="([^"]+)"/i
                ];

                for (const pattern of imagePatterns) {
                    const match = html.match(pattern);
                    if (match && match[1]) {
                        let imageUrl = match[1];
                        
                        // Konwertuj na absolutny URL
                        if (imageUrl.startsWith('//')) {
                            imageUrl = 'https:' + imageUrl;
                        } else if (imageUrl.startsWith('/')) {
                            const base = new URL(baseUrl);
                            imageUrl = base.protocol + '//' + base.host + imageUrl;
                        }
                        
                        // Sprawdź czy to prawidłowy obraz
                        if (imageUrl.match(/\.(jpg|jpeg|png|webp|avif)(\?.*)?$/i) && 
                            !imageUrl.includes('placeholder') && 
                            !imageUrl.includes('default')) {
                            return imageUrl;
                        }
                    }
                }

                return null;
            }

            // Reszta metod pozostaje bez zmian...
            async trySpecialParser(url) {
                const domain = new URL(url).hostname.toLowerCase();
                
                if (domain.includes('kwestiasmaku.com')) {
                    return await this.parseKwestiaSmakuAdvanced(url);
                }
                
                if (domain.includes('aniagotuje.pl')) {
                    return this.parseAniaGotuje(url);
                }
                
                if (domain.includes('przepisy.pl')) {
                    return this.parsePrzepisy(url);
                }
                
                return null;
            }

            async parseKwestiaSmakuAdvanced(url) {
                try {
                    const html = await this.fetchWithUserAgent(url);
                    if (html) {
                        const jsonRecipe = this.parseJsonLD(html);
                        if (jsonRecipe && jsonRecipe.ingredients.length > 2) {
                            jsonRecipe.image = this.extractImageFromHtml(html, url);
                            return jsonRecipe;
                        }
                        
                        const htmlRecipe = this.parseIntelligentHTML(html, url);
                        if (htmlRecipe && htmlRecipe.ingredients.length > 2) {
                            return htmlRecipe;
                        }
                    }
                } catch (e) {
                    console.log('⚠️ Nie udało się pobrać KwestiaSmaku');
                }
                
                return this.parseKwestiaSmakuFallback(url);
            }

            async fetchWithUserAgent(url) {
                const proxies = [
                    `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                    `https://corsproxy.io/?${encodeURIComponent(url)}`
                ];
                
                for (const proxy of proxies) {
                    try {
                        const response = await fetch(proxy, {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const content = data.contents || data.body;
                            if (content && content.length > 2000) {
                                return content;
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                return null;
            }

            parseKwestiaSmakuFallback(url) {
                const urlPath = new URL(url).pathname;
                const pathParts = urlPath.split('/');
                const recipePart = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
                
                let recipeName = recipePart
                    .replace(/przepis\/|buleczki-|cynamonowe-|cinnamon-|rolls/gi, '')
                    .replace(/-/g, ' ')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                
                if (url.includes('buleczki') || url.includes('cynamonowe') || url.includes('cinnamon')) {
                    return {
                        name: 'Bułeczki Cynamonowe (Cinnamon Rolls)',
                        prepTime: '2 godz 30 min',
                        ingredients: [
                            'Ciasto:',
                            '500g mąki pszennej',
                            '250ml ciepłego mleka', 
                            '80g masła',
                            '1 jajko',
                            '7g suchych drożdży',
                            '50g cukru',
                            '1 łyżeczka soli',
                            '',
                            'Nadzienie:',
                            '80g miękkiego masła',
                            '100g cukru',
                            '2 łyżki cynamonu',
                            '',
                            'Lukier:',
                            '200g cukru pudru',
                            '3-4 łyżki mleka',
                            '1 łyżeczka ekstraktu waniliowego'
                        ],
                        instructions: [
                            'Rozpuść drożdże w ciepłym mleku z odrobiną cukru',
                            'W misce wymieszaj mąkę, pozostały cukier i sól',
                            'Dodaj mleko z drożdżami, jajko i roztopione masło',
                            'Wyrabiaj ciasto około 10 minut do gładkości',
                            'Pozostaw do wyrośnięcia na 1 godzinę',
                            'Rozwałkuj ciasto na prostokąt 30x40 cm',
                            'Posmaruj miękkim masłem, posyp cukrem z cynamonem',
                            'Zwiń ciasno w rulonę, pokrój na 12 części',
                            'Ułóż na blaszce, pozostaw na 30 min do wyrośnięcia',
                            'Piecz w 180°C przez 25-30 minut',
                            'Przygotuj lukier mieszając składniki',
                            'Polej jeszcze ciepłe bułeczki lukrem'
                        ],
                        image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=400&h=300&fit=crop'
                    };
                }
                
                return {
                    name: recipeName || 'Przepis z Kwestia Smaku',
                    prepTime: 'Sprawdź na stronie',
                    ingredients: [
                        'Ten przepis wymaga sprawdzenia na oryginalnej stronie.',
                        'Kliknij tytuł przepisu aby przejść do pełnego przepisu.'
                    ],
                    instructions: [
                        'Przejdź do oryginalnej strony aby zobaczyć szczegółowe instrukcje.',
                        'Możesz skopiować przepis ręcznie używając przycisku "Edytuj".'
                    ]
                };
            }

            parseAniaGotuje(url) {
                const recipeName = this.extractNameFromUrl(url, 'aniagotuje.pl');
                
                return {
                    name: recipeName,
                    prepTime: 'Sprawdź na stronie',
                    ingredients: [
                        'Przepis z AniaGotuje.pl',
                        'Kliknij tytuł przepisu aby zobaczyć składniki'
                    ],
                    instructions: [
                        'Zobacz pełne instrukcje na oryginalnej stronie'
                    ]
                };
            }

            parsePrzepisy(url) {
                const recipeName = this.extractNameFromUrl(url, 'przepisy.pl');
                
                return {
                    name: recipeName,
                    prepTime: 'Sprawdź na stronie',
                    ingredients: [
                        'Przepis z Przepisy.pl',
                        'Zobacz pełną listę składników na oryginalnej stronie'
                    ],
                    instructions: [
                        'Instrukcje dostępne na stronie źródłowej'
                    ]
                };
            }

            extractNameFromUrl(url, domain) {
                try {
                    const urlPath = new URL(url).pathname;
                    const parts = urlPath.split('/').filter(p => p.length > 0);
                    const lastPart = parts[parts.length - 1] || parts[parts.length - 2] || '';
                    
                    const name = lastPart
                        .replace(/przepis|recipe|-html|-php/gi, '')
                        .replace(/-|_/g, ' ')
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ')
                        .trim();
                    
                    return name || `Przepis z ${domain}`;
                } catch (e) {
                    return `Przepis z ${domain}`;
                }
            }

            async fetchPageContent(url) {
                const proxies = [
                    `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                    `https://corsproxy.io/?${encodeURIComponent(url)}`,
                    `https://proxy.cors.sh/${url}`,
                    `https://cors-anywhere.herokuapp.com/${url}`
                ];
                
                let lastError = null;
                
                for (let i = 0; i < proxies.length; i++) {
                    const proxy = proxies[i];
                    try {
                        console.log(`🌐 Próba ${i + 1}/${proxies.length}: ${proxy.split('?')[0]}`);
                        
                        const response = await fetch(proxy, {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        const content = data.contents || data.body || data.data;
                        
                        if (!content || content.length < 500) {
                            throw new Error('Zawartość strony jest za krótka lub pusta');
                        }
                        
                        console.log(`✅ Sukces z proxy ${i + 1}`);
                        return content;
                        
                    } catch (error) {
                        console.warn(`❌ Proxy ${i + 1} failed:`, error.message);
                        lastError = error;
                        
                        if (i < proxies.length - 1) {
                            await this.sleep(300);
                        }
                    }
                }
                
                throw new Error(`Wszystkie proxy zawiodły. Ostatni błąd: ${lastError?.message || 'Nieznany błąd'}`);
            }

            parseJsonLD(html) {
                const jsonLdRegex = /<script[^>]*type=["']application\/ld\+json["'][^>]*>(.*?)<\/script>/gis;
                let match;
                
                while ((match = jsonLdRegex.exec(html)) !== null) {
                    try {
                        const data = JSON.parse(match[1]);
                        const items = Array.isArray(data) ? data : [data];
                        
                        for (const item of items) {
                            if (item['@type'] === 'Recipe' || (Array.isArray(item['@type']) && item['@type'].includes('Recipe'))) {
                                const recipe = {
                                    name: this.normalizePolishText(item.name || 'Przepis'),
                                    prepTime: this.parseDuration(item.prepTime || item.cookTime || item.totalTime),
                                    ingredients: this.extractArray(item.recipeIngredient || []),
                                    instructions: this.extractInstructions(item.recipeInstructions || [])
                                };
                                
                                if (recipe.ingredients.length > 0 && recipe.instructions.length > 0) {
                                    return recipe;
                                }
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                return null;
            }

            extractArray(arr) {
                if (!Array.isArray(arr)) return [];
                return arr.map(item => {
                    const text = typeof item === 'string' ? item : (item.text || item.name || String(item));
                    return this.normalizePolishText(text.trim());
                }).filter(item => item.length > 0);
            }

            extractInstructions(instructions) {
                if (!Array.isArray(instructions)) return [];
                return instructions.map(instruction => {
                    const text = typeof instruction === 'string' ? instruction : (instruction.text || instruction.name || String(instruction));
                    return this.normalizePolishText(text.trim());
                }).filter(item => item.length > 0);
            }

            parseDuration(duration) {
                if (!duration) return 'Nie podano';
                const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
                if (!match) return duration;
                
                const hours = parseInt(match[1] || '0');
                const minutes = parseInt(match[2] || '0');
                
                const parts = [];
                if (hours > 0) parts.push(`${hours} godz`);
                if (minutes > 0) parts.push(`${minutes} min`);
                
                return parts.join(' ') || duration;
            }

            async parseWithClaude(html, url) {
                const cleanText = html
                    .replace(/<script[^>]*>.*?<\/script>/gis, '')
                    .replace(/<style[^>]*>.*?<\/style>/gis, '')
                    .replace(/<nav[^>]*>.*?<\/nav>/gis, '')
                    .replace(/<footer[^>]*>.*?<\/footer>/gis, '')
                    .replace(/<[^>]+>/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .substring(0, 4000);

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'x-api-key': this.apiKey,
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 1500,
                        messages: [{
                            role: 'user',
                            content: `Wyodrębnij przepis kulinarny z tekstu strony i zwróć TYLKO poprawny JSON bez dodatkowych komentarzy:

{
  "name": "nazwa przepisu (z polskimi literami!)",
  "prepTime": "czas przygotowania",  
  "ingredients": ["składnik 1", "składnik 2", "składnik 3"],
  "instructions": ["krok 1", "krok 2", "krok 3"]
}

WAŻNE:
- Zachowaj polskie znaki (ą,ć,ę,ł,ń,ó,ś,ź,ż)
- Musisz zwrócić co najmniej 3 składniki i 3 kroki
- Tłumacz na język polski jeśli potrzeba
- Jeśli nie znajdziesz pełnego przepisu, zwróć błąd

Tekst strony:
${cleanText}`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Claude API error: ${response.status}`);
                }

                const data = await response.json();
                const content = data.content[0].text.trim();
                
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        // Normalizuj polskie znaki
                        if (parsed.name) parsed.name = this.normalizePolishText(parsed.name);
                        if (parsed.ingredients) parsed.ingredients = parsed.ingredients.map(this.normalizePolishText);
                        if (parsed.instructions) parsed.instructions = parsed.instructions.map(this.normalizePolishText);
                        return parsed;
                    }
                    throw new Error('Brak JSON w odpowiedzi');
                } catch (e) {
                    throw new Error('Claude zwróciło niepoprawny JSON');
                }
            }

            parseAdvancedHTML(html, url) {
                return this.parseIntelligentHTML(html, url);
            }

            cleanText(text) {
                return this.normalizePolishText(
                    text.replace(/<[^>]+>/g, '')
                        .replace(/\s+/g, ' ')
                        .trim()
                );
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        class RecipeBook {
            constructor() {
                this.recipes = this.loadRecipes();
                this.nextId = this.getNextId();
                this.extractor = new RecipeExtractor();
                this.currentEditId = null;
                this.filteredRecipes = this.recipes;
                this.initializeApp();
                this.setupEventListeners();
                this.displayRecipes();
            }

            initializeApp() {
                this.recipesGrid = document.getElementById('recipesGrid');
                this.addRecipeBtn = document.getElementById('addRecipeBtn');
                this.modal = document.getElementById('recipeModal');
                this.closeModalBtn = document.getElementById('closeModalBtn');
                this.modalBackdrop = document.getElementById('modalBackdrop');
                this.extractBtn = document.getElementById('extractBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.cancelBtn = document.getElementById('cancelBtn');
                
                // Search elements
                this.searchInput = document.getElementById('searchInput');
                this.searchResultsInfo = document.getElementById('searchResultsInfo');
                
                // Modal elements
                this.modalTitle = document.getElementById('modalTitle');
                this.formTitle = document.getElementById('formTitle');
                this.extractionSection = document.getElementById('extractionSection');
                this.dividerSection = document.getElementById('dividerSection');
                
                // View modal elements
                this.viewModal = document.getElementById('recipeViewModal');
                this.closeViewModalBtn = document.getElementById('closeViewModalBtn');
                this.viewModalBackdrop = document.getElementById('viewModalBackdrop');
                this.closeViewBtn = document.getElementById('closeViewBtn');
                this.editFromViewBtn = document.getElementById('editFromViewBtn');
                
                // AI controls
                this.aiCheckbox = document.getElementById('aiEnabled');
                this.apiKeyInput = document.getElementById('apiKeyInput');
                
                // Load AI state
                const aiEnabled = localStorage.getItem('ai_enabled') === 'true';
                this.aiCheckbox.checked = aiEnabled;
                this.toggleApiKeyInput();
            }

            setupEventListeners() {
                // Search
                this.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));

                // Modal
                this.addRecipeBtn.addEventListener('click', () => this.openModal());
                this.closeModalBtn.addEventListener('click', () => this.closeModal());
                this.cancelBtn.addEventListener('click', () => this.closeModal());
                this.modalBackdrop.addEventListener('click', () => this.closeModal());

                // View modal
                this.closeViewModalBtn.addEventListener('click', () => this.closeViewModal());
                this.viewModalBackdrop.addEventListener('click', () => this.closeViewModal());
                this.closeViewBtn.addEventListener('click', () => this.closeViewModal());
                this.editFromViewBtn.addEventListener('click', () => {
                    this.closeViewModal();
                    this.openModal(this.currentViewId);
                });

                // Recipe
                this.extractBtn.addEventListener('click', () => this.extractRecipe());
                this.saveBtn.addEventListener('click', () => this.saveRecipe());

                // AI controls
                this.aiCheckbox.addEventListener('change', () => {
                    localStorage.setItem('ai_enabled', this.aiCheckbox.checked);
                    this.toggleApiKeyInput();
                });

                this.apiKeyInput.addEventListener('input', (e) => {
                    this.extractor.setApiKey(e.target.value);
                });

                // Load saved API key
                if (this.extractor.apiKey) {
                    this.apiKeyInput.value = this.extractor.apiKey;
                }

                // ESC key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!this.modal.classList.contains('hidden')) {
                            this.closeModal();
                        } else if (!this.viewModal.classList.contains('hidden')) {
                            this.closeViewModal();
                        }
                    }
                });
            }

            // Wyszukiwarka na żywo
            handleSearch(query) {
                if (!query.trim()) {
                    this.filteredRecipes = this.recipes;
                    this.searchResultsInfo.classList.add('hidden');
                } else {
                    const searchTerm = query.toLowerCase().trim();
                    this.filteredRecipes = this.recipes.filter(recipe => {
                        return recipe.name.toLowerCase().includes(searchTerm) ||
                               recipe.ingredients.some(ingredient => 
                                   ingredient.toLowerCase().includes(searchTerm)
                               ) ||
                               recipe.instructions.some(instruction => 
                                   instruction.toLowerCase().includes(searchTerm)
                               );
                    });
                    
                    // Pokaż info o wynikach
                    document.getElementById('resultsCount').textContent = this.filteredRecipes.length;
                    this.searchResultsInfo.classList.remove('hidden');
                }
                
                this.displayRecipes();
            }

            toggleApiKeyInput() {
                if (this.aiCheckbox.checked) {
                    this.apiKeyInput.classList.remove('hidden');
                } else {
                    this.apiKeyInput.classList.add('hidden');
                }
            }

            openModal(editId = null) {
                this.currentEditId = editId;
                this.modal.classList.remove('hidden');
                
                if (editId) {
                    this.modalTitle.textContent = 'Edytuj Przepis';
                    this.formTitle.textContent = '📝 Edytuj przepis';
                    this.extractionSection.classList.add('hidden');
                    this.dividerSection.classList.add('hidden');
                    
                    const recipe = this.recipes.find(r => r.id === editId);
                    if (recipe) {
                        document.getElementById('recipeName').value = recipe.name;
                        document.getElementById('prepTime').value = recipe.prepTime;
                        document.getElementById('ingredients').value = recipe.ingredients.join('\n');
                        document.getElementById('instructions').value = recipe.instructions.join('\n');
                    }
                } else {
                    this.modalTitle.textContent = 'Dodaj Nowy Przepis';
                    this.formTitle.textContent = '📝 Wprowadź przepis ręcznie';
                    this.extractionSection.classList.remove('hidden');
                    this.dividerSection.classList.remove('hidden');
                    this.clearForm();
                }
                
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                this.modal.classList.add('hidden');
                this.currentEditId = null;
                this.clearForm();
                document.body.style.overflow = '';
            }

            openViewModal(id) {
                this.currentViewId = id;
                const recipe = this.recipes.find(r => r.id === id);
                
                if (!recipe) return;
                
                document.getElementById('viewModalTitle').textContent = recipe.name;
                document.getElementById('viewRecipeName').textContent = recipe.name;
                document.getElementById('viewRecipeTime').textContent = `⏱️ ${recipe.prepTime}`;
                
                // Set image
                const imageContainer = document.getElementById('viewRecipeImage');
                if (recipe.image) {
                    imageContainer.innerHTML = `<img src="${recipe.image}" alt="${recipe.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='🍳';">`;
                } else {
                    imageContainer.innerHTML = '🍳';
                }
                
                // Set source link
                const sourceContainer = document.getElementById('viewRecipeSource');
                const sourceLink = document.getElementById('viewSourceLink');
                if (recipe.source) {
                    sourceLink.href = recipe.source;
                    sourceLink.textContent = `🔗 Zobacz na ${new URL(recipe.source).hostname}`;
                    sourceContainer.classList.remove('hidden');
                } else {
                    sourceContainer.classList.add('hidden');
                }
                
                // Set ingredients
                const ingredientsList = document.getElementById('viewRecipeIngredients');
                ingredientsList.innerHTML = recipe.ingredients.map(ingredient => 
                    `<li>${ingredient}</li>`
                ).join('');
                
                // Set instructions
                const instructionsList = document.getElementById('viewRecipeInstructions');
                instructionsList.innerHTML = recipe.instructions.map(instruction => 
                    `<li>${instruction}</li>`
                ).join('');
                
                this.viewModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            closeViewModal() {
                this.viewModal.classList.add('hidden');
                this.currentViewId = null;
                document.body.style.overflow = '';
            }

            clearForm() {
                document.getElementById('recipeUrl').value = '';
                document.getElementById('recipeName').value = '';
                document.getElementById('prepTime').value = '';
                document.getElementById('ingredients').value = '';
                document.getElementById('instructions').value = '';
                
                const status = document.getElementById('extractionStatus');
                status.classList.add('hidden');
            }

            async extractRecipe() {
                const url = document.getElementById('recipeUrl').value.trim();
                
                if (!url) {
                    this.showExtractionStatus('Proszę wkleić link do przepisu', 'error');
                    return;
                }

                try {
                    new URL(url);
                } catch (e) {
                    this.showExtractionStatus('Nieprawidłowy adres URL', 'error');
                    return;
                }

                const extractBtn = this.extractBtn;
                const extractText = extractBtn.querySelector('.extract-text');
                const spinner = extractBtn.querySelector('.loading-spinner');
                
                extractBtn.disabled = true;
                extractText.classList.add('hidden');
                spinner.classList.remove('hidden');

                const useAI = this.aiCheckbox.checked && this.extractor.apiKey.length > 10;
                
                const domain = new URL(url).hostname;
                this.showExtractionStatus(`🔍 Analizuję ${domain}...`, 'info');

                try {
                    const recipe = await this.extractor.extractRecipe(url, useAI);
                    
                    if (recipe && recipe.ingredients.length > 0 && recipe.instructions.length > 0) {
                        document.getElementById('recipeName').value = recipe.name;
                        document.getElementById('prepTime').value = recipe.prepTime;
                        document.getElementById('ingredients').value = recipe.ingredients.join('\n');
                        document.getElementById('instructions').value = recipe.instructions.join('\n');

                        if (useAI) {
                            this.showExtractionStatus('✅ Przepis wyodrębniony przez Claude AI!', 'success');
                        } else {
                            this.showExtractionStatus('✅ Przepis wyodrębniony!', 'success');
                        }
                    } else {
                        throw new Error('Przepis jest niepełny - brak składników lub instrukcji');
                    }
                    
                } catch (error) {
                    console.error('Błąd ekstraktora:', error);
                    this.showExtractionStatus(`❌ ${error.message}`, 'error');
                    
                } finally {
                    extractBtn.disabled = false;
                    extractText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                }
            }

            showExtractionStatus(message, type) {
                const status = document.getElementById('extractionStatus');
                status.textContent = message;
                status.className = `extraction-status ${type}`;
                status.classList.remove('hidden');
            }

            saveRecipe() {
                const name = document.getElementById('recipeName').value.trim();
                const prepTime = document.getElementById('prepTime').value.trim();
                const ingredientsText = document.getElementById('ingredients').value.trim();
                const instructionsText = document.getElementById('instructions').value.trim();
                const sourceUrl = document.getElementById('recipeUrl').value.trim();

                if (!name || !ingredientsText || !instructionsText) {
                    alert('Proszę wypełnić wszystkie wymagane pola!');
                    return;
                }

                const ingredients = ingredientsText.split('\n').filter(item => item.trim());
                const instructions = instructionsText.split('\n').filter(item => item.trim());

                if (this.currentEditId) {
                    const recipeIndex = this.recipes.findIndex(r => r.id === this.currentEditId);
                    if (recipeIndex !== -1) {
                        this.recipes[recipeIndex] = {
                            ...this.recipes[recipeIndex],
                            name,
                            prepTime: prepTime || 'Nie podano',
                            ingredients,
                            instructions
                        };
                    }
                } else {
                    const newRecipe = {
                        id: this.nextId++,
                        name,
                        prepTime: prepTime || 'Nie podano',
                        ingredients,
                        instructions,
                        source: sourceUrl || null,
                        image: null,
                        dateAdded: new Date().toISOString()
                    };
                    
                    this.recipes.push(newRecipe);
                }

                this.saveRecipes();
                this.handleSearch(this.searchInput.value); // Refresh filtered results
                this.closeModal();
                
                this.showToast(this.currentEditId ? '✅ Przepis zaktualizowany!' : '✅ Przepis zapisany!');
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #059669;
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 0.5rem;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    font-weight: 500;
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            deleteRecipe(id) {
                if (confirm('Czy na pewno chcesz usunąć ten przepis?')) {
                    this.recipes = this.recipes.filter(recipe => recipe.id !== id);
                    this.saveRecipes();
                    this.handleSearch(this.searchInput.value); // Refresh filtered results
                    this.showToast('🗑️ Przepis usunięty');
                }
            }

            editRecipe(id) {
                this.openModal(id);
            }

            viewRecipe(id) {
                this.openViewModal(id);
            }

            displayRecipes() {
                const recipesToShow = this.filteredRecipes;
                
                if (this.recipes.length === 0) {
                    this.recipesGrid.innerHTML = `
                        <div class="empty-state">
                            <h3>🍽️ Brak przepisów</h3>
                            <p>Dodaj swój pierwszy przepis!</p>
                            <p><small>💡 Obsługujemy wszystkie strony kulinarne z inteligentnym parserem</small></p>
                            <p><small>🤖 Włącz Claude AI dla najlepszych rezultatów</small></p>
                        </div>
                    `;
                    return;
                }

                if (recipesToShow.length === 0) {
                    this.recipesGrid.innerHTML = `
                        <div class="no-results">
                            <h3>🔍 Brak wyników</h3>
                            <p>Nie znaleziono przepisów pasujących do wyszukiwania "${this.searchInput.value}"</p>
                            <p><small>Spróbuj wyszukać inną nazwę lub składnik</small></p>
                        </div>
                    `;
                    return;
                }

                this.recipesGrid.innerHTML = recipesToShow.map(recipe => `
                    <div class="recipe-card">
                        <div class="recipe-image">
                            ${recipe.image ? 
                                `<img src="${recipe.image}" alt="${recipe.name}" onerror="this.style.display='none'; this.parentNode.querySelector('.recipe-image-fallback').style.display='flex';">
                                 <div class="recipe-image-fallback" style="display: none;">🍳</div>` : 
                                '🍳'
                            }
                        </div>
                        <div class="recipe-content">
                            <div class="recipe-header">
                                <h3 class="recipe-title">
                                    ${recipe.source ? 
                                        `<a href="${recipe.source}" target="_blank">${recipe.name}</a>` : 
                                        recipe.name
                                    }
                                </h3>
                                <span class="recipe-time">⏱️ ${recipe.prepTime}</span>
                            </div>
                            
                            <div class="recipe-ingredients">
                                <h4>📋 Składniki:</h4>
                                <ul class="ingredients-list">
                                    ${recipe.ingredients.slice(0, 4).map(ingredient => `<li>${ingredient}</li>`).join('')}
                                    ${recipe.ingredients.length > 4 ? `<li><em>...i ${recipe.ingredients.length - 4} więcej</em></li>` : ''}
                                </ul>
                            </div>
                            
                            <div class="recipe-instructions">
                                <h4>👩‍🍳 Przygotowanie:</h4>
                                <ol class="instructions-list">
                                    ${recipe.instructions.slice(0, 3).map(instruction => `<li>${instruction}</li>`).join('')}
                                    ${recipe.instructions.length > 3 ? `<li><em>...i ${recipe.instructions.length - 3} więcej kroków</em></li>` : ''}
                                </ol>
                            </div>
                            
                            <div class="recipe-actions">
                                <button class="view-btn btn--sm" onclick="app.viewRecipe(${recipe.id})">
                                    👁️ Otwórz
                                </button>
                                <button class="edit-btn btn--sm" onclick="app.editRecipe(${recipe.id})">
                                    ✏️ Edytuj
                                </button>
                                <button class="delete-btn btn--sm" onclick="app.deleteRecipe(${recipe.id})">
                                    🗑️ Usuń
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            loadRecipes() {
                try {
                    const saved = localStorage.getItem('recipeBook');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            }

            saveRecipes() {
                try {
                    localStorage.setItem('recipeBook', JSON.stringify(this.recipes));
                } catch (e) {
                    console.error('Error saving recipes:', e);
                }
            }

            getNextId() {
                return this.recipes.length > 0 ? Math.max(...this.recipes.map(r => r.id)) + 1 : 1;
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new RecipeBook();
        });
    </script>
</body>
</html>
